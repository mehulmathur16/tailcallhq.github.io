<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.6.3">
<title data-rh="true">The truth about scaling Automatic Persisted Queries</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://tailcall.run/blog/the-truth-about-scaling-automatic-persisted-queries/"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="The truth about scaling Automatic Persisted Queries | Tailcall"><meta data-rh="true" name="description" content="Learn about the limitations and potential scaling issues that accompany Automatic Persisted Queries (APQ)."><meta data-rh="true" property="og:description" content="Learn about the limitations and potential scaling issues that accompany Automatic Persisted Queries (APQ)."><meta data-rh="true" property="og:image" content="https://tailcall.run/images/blog/apq-cover.png"><meta data-rh="true" name="twitter:image" content="https://tailcall.run/images/blog/apq-cover.png"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2023-08-11T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/tusharmath"><link data-rh="true" rel="icon" href="/images/favicon.ico"><link data-rh="true" rel="alternate" href="https://tailcall.run/blog/the-truth-about-scaling-automatic-persisted-queries/" hreflang="en"><link data-rh="true" rel="alternate" href="https://tailcall.run/blog/the-truth-about-scaling-automatic-persisted-queries/" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://X27WDVHRQ3-dsn.algolia.net" crossorigin="anonymous"><link data-rh="true" rel="canonical" href="https://tailcall.hashnode.dev/the-truth-about-scaling-automatic-persisted-queries"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","@id":"https://tailcall.run/blog/the-truth-about-scaling-automatic-persisted-queries","mainEntityOfPage":"https://tailcall.run/blog/the-truth-about-scaling-automatic-persisted-queries","url":"https://tailcall.run/blog/the-truth-about-scaling-automatic-persisted-queries","headline":"The truth about scaling Automatic Persisted Queries","name":"The truth about scaling Automatic Persisted Queries","description":"Learn about the limitations and potential scaling issues that accompany Automatic Persisted Queries (APQ).","datePublished":"2023-08-11T00:00:00.000Z","author":{"@type":"Person","name":"Tushar Mathur","description":"CEO @ Tailcall | Love to talk about programming, scale, distributed systems and building high performance systems.","url":"https://github.com/tusharmath","image":"https://avatars.githubusercontent.com/u/194482?v=4"},"image":{"@type":"ImageObject","@id":"https://tailcall.run/images/blog/apq-cover.png","url":"https://tailcall.run/images/blog/apq-cover.png","contentUrl":"https://tailcall.run/images/blog/apq-cover.png","caption":"title image for the blog post: The truth about scaling Automatic Persisted Queries"},"keywords":[],"isPartOf":{"@type":"Blog","@id":"https://tailcall.run/blog","name":"Feed of Tailcall blogs"}}</script><link rel="search" type="application/opensearchdescription+xml" title="Tailcall" href="/opensearch.xml">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Tailcall RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Tailcall Atom Feed">
<link rel="alternate" type="application/json" href="/blog/feed.json" title="Tailcall JSON Feed">




<script id="chatbotscript" data-accountid="CZPG9aVdtk59Tjz4SMTu8w==" data-websiteid="75VGI0NlBqessD4BQn2pFg==" src="https://app.robofy.ai/bot/js/common.js?v=1734946557392"></script>
<script type="application/ld+json">{"@context":"https://schema.org/","@type":"WebSite","name":"Tailcall","url":"https://tailcall.run/"}</script><link rel="stylesheet" href="/assets/css/styles.d55587b5.css">
<script src="/assets/js/runtime~main.c06c596d.js" defer="defer"></script>
<script src="/assets/js/main.68750f4e.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top navbarHideable_m1mJ"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/icons/companies/tailcall.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/icons/companies/tailcall.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div></a><a class="navbar__item navbar__link" href="/">Home</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog/">Blog</a><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Developers</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/">
    <div class="flex items-center p-1">
      <img class="mr-2" src="/images/home/book.svg" alt="Docs" icon style="width: 16px; height: 16px;">
      <span class="text-content-tiny font-bold lg:text-content-small lg:font-medium">Docs</span>
    </div></a></li><li><a class="dropdown__link" href="/graphql/">
    <div class="flex items-center p-1">
      <img class="mr-2" src="/images/home/archive.svg" alt="Learn" icon style="width: 16px; height: 16px;">
      <span class="text-content-tiny font-bold lg:text-content-small lg:font-medium">Learn</span>
    </div></a></li><li><a class="dropdown__link" href="/releases/">
    <div class="flex items-center p-1">
      <img class="mr-2" src="/images/home/git-merge.svg" alt="Releases" icon style="width: 16px; height: 16px;">
      <span class="text-content-tiny font-bold lg:text-content-small lg:font-medium">Releases</span>
    </div></a></li></ul></div></div><div class="navbar__items navbar__items--right"><div class="hidden lg:flex search-icon-navbar navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_eExm"><div class="container mx-auto mt-3 mb-10 md:my-8 px-4"><div class="flex flex-row"><div class="w-full"><article><header><a class="flex items-center gap-2 my-8 cursor-pointer !no-underline" href="/blog/"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-left"><path d="m12 19-7-7 7-7"></path><path d="M19 12H5"></path></svg><span class="text-content-small text-tailCall-light-600">Back to Blogs</span></a><h1 class="title_xvU1">The truth about scaling Automatic Persisted Queries</h1><div class="container_iJTo margin-vert--md"><time datetime="2023-08-11T00:00:00.000Z">August 11, 2023</time> · <!-- -->7 min read</div></header><img src="/images/blog/apq-cover.png" alt="Cover Image for The truth about scaling Automatic Persisted Queries"><div id="__blog-post-container" class="markdown"><p>Persisted queries are often hailed as a solution to several challenges in GraphQL related to network performance, caching, and maintenance. However, they may not always be the silver bullet they appear to be. This post delves into the concept of persisted queries (PQ) and automatic persisted queries (APQ), highlighting the limitations and potential scaling issues that accompany these technologies.</p>
<!-- -->
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="the-problem">The Problem<a href="#the-problem" class="hash-link" aria-label="Direct link to The Problem" title="Direct link to The Problem">​</a></h3>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="large-queries">Large Queries<a href="#large-queries" class="hash-link" aria-label="Direct link to Large Queries" title="Direct link to Large Queries">​</a></h4>
<p>Clients send queries to a GraphQL server as HTTP requests that include the query as the body. When these queries become large, they can lead to increased latency and network usage, degrading client performance.</p>
<p>For example, a normal GraphQL query might look like this:</p>
<div class="rounded-3xl overflow-hidden"><div class="bg-[#35353A] p-4 flex justify-between items-center"><span class="text-white text-xs font-space-mono"></span><div class="relative"><button aria-label="Copy code" class="flex flex-row items-center bg-transparent appearance-none border-none"><img src="/icons/basic/copy-icon.svg" alt="Copy Icon" class="w-4 h-4 cursor-pointer hover:opacity-80 transition-opacity duration-150"></button></div></div><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#fff;--prism-background-color:#303037"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#fff;background-color:#303037"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#fff"><span class="token plain">curl -X POST -H &quot;Content-Type: application/json&quot; \</span><br></span><span class="token-line" style="color:#fff"><span class="token plain">  --data &#x27;{&quot;query&quot;: &quot;{ largeQuery { field1 field2 ... } }&quot;}&#x27; \</span><br></span><span class="token-line" style="color:#fff"><span class="token plain">  http://your-graphql-server.com/graphql</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div>
<p>Each GraphQL query is parsed every time the server receives it. If it&#x27;s large, the parsing can take a significant amount of time, increasing latency even further.</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="legacy-infrastructure">Legacy Infrastructure<a href="#legacy-infrastructure" class="hash-link" aria-label="Direct link to Legacy Infrastructure" title="Direct link to Legacy Infrastructure">​</a></h4>
<p>Existing CDN infrastructure is designed to cache only GET calls. To make a GraphQL request, one must make a POST call. This limits the usage of CDNs for caching purposes.</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="solution-persisted-queries-pq">Solution: Persisted Queries (PQ)<a href="#solution-persisted-queries-pq" class="hash-link" aria-label="Direct link to Solution: Persisted Queries (PQ)" title="Direct link to Solution: Persisted Queries (PQ)">​</a></h3>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="definition-and-benefits">Definition and Benefits<a href="#definition-and-benefits" class="hash-link" aria-label="Direct link to Definition and Benefits" title="Direct link to Definition and Benefits">​</a></h4>
<p>To enhance network performance for large query strings, GraphQL server supports Persisted Queries (PQ). A PQ is a GraphQL query cached server-side, identified by its SHA-256 hash. Clients send this identifier instead of the query, dramatically reducing request sizes (without affecting response), saving parsing time, and enabling GET calls instead of POST.</p>
<p>A PQ request might look like this:</p>
<div class="rounded-3xl overflow-hidden"><div class="bg-[#35353A] p-4 flex justify-between items-center"><span class="text-white text-xs font-space-mono"></span><div class="relative"><button aria-label="Copy code" class="flex flex-row items-center bg-transparent appearance-none border-none"><img src="/icons/basic/copy-icon.svg" alt="Copy Icon" class="w-4 h-4 cursor-pointer hover:opacity-80 transition-opacity duration-150"></button></div></div><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#fff;--prism-background-color:#303037"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#fff;background-color:#303037"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#fff"><span class="token plain">curl -X GET -H &quot;Content-Type: application/json&quot; \</span><br></span><span class="token-line" style="color:#fff"><span class="token plain">  --data-urlencode &#x27;extensions={&quot;persistedQuery&quot;:{&quot;version&quot;:1,&quot;sha256Hash&quot;:&quot;&lt;SHA 256&gt;&quot;}}&#x27; \</span><br></span><span class="token-line" style="color:#fff"><span class="token plain">  http://your-graphql-server.com/graphql</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="application-with-cdns">Application with CDNs<a href="#application-with-cdns" class="hash-link" aria-label="Direct link to Application with CDNs" title="Direct link to Application with CDNs">​</a></h4>
<p>Using the PQ link automatically sends short hashed queries as GET requests, enabling CDNs to serve them.</p>
<h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="latency-reduction"><strong>Latency Reduction</strong><a href="#latency-reduction" class="hash-link" aria-label="Direct link to latency-reduction" title="Direct link to latency-reduction">​</a></h5>
<ul>
<li>
<p><strong>No Parsing Overhead</strong>: Since the query isn&#x27;t sent to the server, the parsing stage, which can be computationally expensive, is eliminated. This saves valuable server processing time, directly reducing client latency.</p>
</li>
<li>
<p><strong>Network Efficiency</strong>: By transmitting only the hash instead of the full query, the request size is dramatically reduced, leading to faster network transmission and lower latency.</p>
</li>
</ul>
<h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="security-enhancements"><strong>Security Enhancements</strong><a href="#security-enhancements" class="hash-link" aria-label="Direct link to security-enhancements" title="Direct link to security-enhancements">​</a></h5>
<ul>
<li>
<p><strong>Control Over Allowed Queries</strong>: The server can start with a finite set of &quot;allowed&quot; queries, ensuring that unauthorized or unoptimized GraphQL requests cannot be made. This control is a significant safeguard for production environments, preventing potential abuse or inefficiencies.</p>
</li>
<li>
<p><strong>Reduction in Attack Surface</strong>: By limiting the queries to a pre-defined set, the risk of malicious queries is reduced, enhancing the security profile of the application.</p>
</li>
</ul>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="problem">Problem<a href="#problem" class="hash-link" aria-label="Direct link to Problem" title="Direct link to Problem">​</a></h4>
<p>While PQs provide remarkable benefits, they are not without challenges:</p>
<ul>
<li>
<p><strong>Schema Rigidity</strong>: If you aim to keep the schema open and queries dynamic, supporting any possible query becomes complex.</p>
</li>
<li>
<p><strong>Maintenance of Cached Queries</strong>: Managing the cache of allowed queries and keeping them in sync with evolving client needs can become a maintenance burden, especially in a fast-changing environment.</p>
</li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="automatic-persisted-queries-apqs">Automatic Persisted Queries (APQs)<a href="#automatic-persisted-queries-apqs" class="hash-link" aria-label="Direct link to Automatic Persisted Queries (APQs)" title="Direct link to Automatic Persisted Queries (APQs)">​</a></h3>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="apqs-vs-pqs">APQs vs PQs<a href="#apqs-vs-pqs" class="hash-link" aria-label="Direct link to APQs vs PQs" title="Direct link to APQs vs PQs">​</a></h4>
<p>APQs are a supposed improvement over PQs. In a PQ setup, the server runs with a known set of queries, meaning client changes require server updates. This has implications for maintenance costs, particularly in supporting multiple versions of queries and making a server deployment for every change in the client query. APQs were introduced to overcome these challenges.</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="how-apqs-work">How APQs Work<a href="#how-apqs-work" class="hash-link" aria-label="Direct link to How APQs Work" title="Direct link to How APQs Work">​</a></h4>
<p>The APQ process is a two-step approach:</p>
<ol>
<li>
<p><strong>Hash Request</strong>: The client sends a request with the hash of the query. If the server recognizes the hash, it returns the corresponding response:</p>
<div class="rounded-3xl overflow-hidden"><div class="bg-[#35353A] p-4 flex justify-between items-center"><span class="text-white text-xs font-space-mono"></span><div class="relative"><button aria-label="Copy code" class="flex flex-row items-center bg-transparent appearance-none border-none"><img src="/icons/basic/copy-icon.svg" alt="Copy Icon" class="w-4 h-4 cursor-pointer hover:opacity-80 transition-opacity duration-150"></button></div></div><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#fff;--prism-background-color:#303037"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#fff;background-color:#303037"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#fff"><span class="token plain">curl -X GET -H &quot;Content-Type: application/json&quot; \</span><br></span><span class="token-line" style="color:#fff"><span class="token plain">  --data-urlencode &#x27;extensions={&quot;persistedQuery&quot;:{&quot;version&quot;:1,&quot;sha256Hash&quot;:&quot;&lt;SHA 256&gt;&quot;}}&#x27; \</span><br></span><span class="token-line" style="color:#fff"><span class="token plain">  http://your-graphql-server.com/graphql</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div>
</li>
<li>
<p><strong>Full Query Request</strong>: If the server does not recognize the hash, it returns an error. The client then sends a new request that includes both the hash and the full query string:</p>
<div class="rounded-3xl overflow-hidden"><div class="bg-[#35353A] p-4 flex justify-between items-center"><span class="text-white text-xs font-space-mono"></span><div class="relative"><button aria-label="Copy code" class="flex flex-row items-center bg-transparent appearance-none border-none"><img src="/icons/basic/copy-icon.svg" alt="Copy Icon" class="w-4 h-4 cursor-pointer hover:opacity-80 transition-opacity duration-150"></button></div></div><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#fff;--prism-background-color:#303037"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#fff;background-color:#303037"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#fff"><span class="token plain">curl --get http://localhost:4000/graphql \</span><br></span><span class="token-line" style="color:#fff"><span class="token plain">  --header &#x27;content-type: application/json&#x27; \</span><br></span><span class="token-line" style="color:#fff"><span class="token plain">  --data-urlencode &#x27;{&quot;query&quot;: &quot;{ largeQuery { field1 field2 ... } }&quot;}&#x27; \</span><br></span><span class="token-line" style="color:#fff"><span class="token plain">  --data-urlencode &#x27;extensions={&quot;persistedQuery&quot;:{&quot;version&quot;:1,&quot;sha256Hash&quot;:&quot;&lt;HASH&gt;&quot;}}&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div>
<p>The server parses the full query, caches it for future use, and returns the GraphQL response. Subsequent requests use the hash.</p>
</li>
</ol>
<p>This process optimizes network performance while allowing flexibility in the queries that can be run. You can read more about APQ <a href="https://www.apollographql.com/docs/apollo-server/performance/apq/" target="_blank" rel="noopener noreferrer">here</a></p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="problems-with-apqs">Problems with APQs<a href="#problems-with-apqs" class="hash-link" aria-label="Direct link to Problems with APQs" title="Direct link to Problems with APQs">​</a></h3>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="thundering-herd-problem">Thundering Herd Problem<a href="#thundering-herd-problem" class="hash-link" aria-label="Direct link to Thundering Herd Problem" title="Direct link to Thundering Herd Problem">​</a></h4>
<p>Consider a situation where a server has just been deployed or restarted, and the cache is empty. Now, multiple clients send hash requests for queries that are not yet cached.</p>
<ol>
<li>
<p><strong>Massive Error Responses</strong>: Since the cache is empty, the server returns errors for all hash requests, signaling the clients to send the full query strings.</p>
</li>
<li>
<p><strong>Simultaneous Full Query Requests</strong>: All clients now simultaneously send full query requests, causing a sudden surge in demand.</p>
</li>
<li>
<p><strong>Server Strain</strong>: The server must parse and cache each unique query, placing significant strain on its resources. This can lead to increased latency and even server failure if the demand is too high.</p>
</li>
<li>
<p><strong>Repeated Pattern</strong>: If the server struggles to cache the queries quickly enough, the clients may continue to receive errors and retry the full query requests, perpetuating the problem.</p>
</li>
</ol>
<p>In an environment with many clients and dynamically changing queries, the system can become vulnerable to sudden surges in demand. This vulnerability can undermine the performance benefits APQs are designed to provide, leading to potential system instability.</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="cache-limitations">Cache Limitations<a href="#cache-limitations" class="hash-link" aria-label="Direct link to Cache Limitations" title="Direct link to Cache Limitations">​</a></h4>
<p>Queries are typically cached in memory, requiring cache warmup on each instance, hindering deployment on server-less solutions. An alternative could be using a centralized cache, but it typically nullifies performance gains due to serialization, deserialization, and IO call overhead.</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="security-concerns">Security Concerns<a href="#security-concerns" class="hash-link" aria-label="Direct link to Security Concerns" title="Direct link to Security Concerns">​</a></h4>
<p>Automatically persisting queries can cause memory leaks, as clients can send varying query combinations, exhausting server memory. Mitigation through cache size limits and eviction mechanisms may lead to frequent cache misses, leading to doubling request numbers.</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="possible-solution">Possible Solution<a href="#possible-solution" class="hash-link" aria-label="Direct link to Possible Solution" title="Direct link to Possible Solution">​</a></h3>
<p>Persistent queries are a great improvement over regular queries. They clearly improve performance and are more secure. APQs on the other hand though try to give more flexibility they can become quite messy to deal with as you scale. One alternative that is significantly more effective, is to run GraphQL on Edge itself. Essentially write your own CDN layer that is smart enough to understand that it&#x27;s a graphQL and deploy it on edge with caching and whatnot! This is hard, and that&#x27;s exactly what <a href="https://tailcall.run" target="_blank" rel="noopener noreferrer">Tailcall</a> helps solve.</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">​</a></h3>
<p>Automatic persisted queries, while offering some advantages in network performance, reveal significant challenges when it comes to scaling. The complexities of caching, potential security risks, and the inherent problems with automatic persistence highlight that persisted queries may not be the one-size-fits-all solution they are often portrayed as.</p>
<p>The question of whether to implement PQ or APQ must be approached with caution, taking into account the specific requirements and potential scalability issues of your system. While they may serve as a useful tool in certain scenarios, understanding the limitations and conducting thorough analysis is vital to avoid falling into the trap of a solution that doesn&#x27;t truly scale. This blog post has aimed to shed light on these complexities, encouraging a more nuanced perspective on a topic that is often oversimplified.</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="!no-underline flex gap-3 items-center" href="/blog/graphql-conf-2023/"><div class="w-10 h-10 p-2 bg-tailCall-yellow flex justify-center items-center rounded-full"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-left"><path d="m12 19-7-7 7-7"></path><path d="M19 12H5"></path></svg></div><div class="hidden md:block"><div class="text-tailCall-dark-100 text-[12px] font-medium">Newer post</div><div class="pagination-nav__label text-black text-content-small font-medium">GraphQL Conf 2023</div></div></a><a class="!no-underline flex gap-3 items-center" href="/blog/unraveling-the-challenges-of-bff-federation/"><div class="hidden md:block"><div class="text-tailCall-dark-100 text-[12px] font-medium">Older post</div><div class="pagination-nav__label text-black text-content-small font-medium">Unraveling the Challenges of BFF Federation</div></div><div class="w-10 h-10 p-2 bg-tailCall-yellow flex justify-center items-center rounded-full"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-right"><path d="M5 12h14"></path><path d="m12 5 7 7-7 7"></path></svg></div></a></nav></div></div></div></div><footer class="bg-tailCall-dark-700 grid-dark pt-SPACE_16 pb-SPACE_05 flex flex-col items-center justify-center gap-SPACE_10 w-full relative px-SPACE_04"><svg xmlns="http://www.w3.org/2000/svg" width="115" height="40" fill="none" viewBox="0 0 115 40" class="w-[120px] h-10 z-10"><g clip-path="url(#a)"><path fill="#FDEA2E" d="m33.197 8.055-.965-.562-1.111-.644-1.16-.675-1.063-.618L20.561.711a5.26 5.26 0 0 0-5.284 0L2.642 8.055A5.32 5.32 0 0 0 0 12.658V27.34a5.32 5.32 0 0 0 2.642 4.604l6.4 3.718 2.27 1.32 3.965 2.304c1.635.95 3.65.95 5.284 0l12.636-7.342a5.32 5.32 0 0 0 2.641-4.604V12.658c0-1.9-1.007-3.655-2.641-4.605z"></path><path fill="#000" fill-rule="evenodd" d="M28.668 26.788a2.62 2.62 0 0 1-2.618 2.625 2.6 2.6 0 0 1-1.562-.518l-3.735 2.162-.042.023-.465.262a4.32 4.32 0 0 1-4.222.037 4.36 4.36 0 0 1-2.302-3.869v-9.562h-.002l-3.41 1.973q.014.136.014.274a2.617 2.617 0 1 1-5.222-.283 2.62 2.62 0 0 1 2.604-2.343c.61 0 1.17.21 1.615.56l4.399-2.544v-1.697c0-1.128.602-2.166 1.575-2.726l4.788-2.746a1.04 1.04 0 0 1 1.423.388 1.05 1.05 0 0 1-.388 1.427l-4.788 2.747a1.05 1.05 0 0 0-.527.91V27.51c0 1.76 1.89 2.87 3.419 2.008l.666-.375 3.56-2.06a2 2 0 0 1-.015-.215q-.003-.04-.002-.08a2.62 2.62 0 0 1 2.62-2.625q.052 0 .105.002.04 0 .08.004l.068.006q.125.012.247.036l.08.017q.04.009.08.02.038.009.074.02.049.014.097.03l.017.006q.065.022.129.049.072.028.142.061a2.7 2.7 0 0 1 .41.245l.024.016q0 .002.002.002a2.62 2.62 0 0 1 1.061 2.078z" clip-rule="evenodd"></path><path fill="#000" fill-rule="evenodd" d="M28.67 10.953c0 .34-.064.664-.182.96q-.03.074-.062.147l-.035.071a2 2 0 0 1-.077.143q-.015.03-.034.058a2.5 2.5 0 0 1-.513.603l-.074.063a2.5 2.5 0 0 1-.505.321 2.61 2.61 0 0 1-2.816-.353l-4.54 2.627v10.445c0 .578-.466 1.046-1.042 1.046a1.044 1.044 0 0 1-1.043-1.046v-10.69c0-.564.283-1.086.746-1.395l.017-.01q0 0 .003-.002l.075-.044 4.847-2.804q0-.015-.002-.031-.004-.053-.005-.108a2.619 2.619 0 0 1 2.822-2.62h.001q.078.006.155.018h.003l.154.026.005.002.048.01q.037.007.071.017.065.015.128.035.023.007.047.015.023.006.046.016.047.015.092.034.255.097.479.246c.312.202.578.47.778.785a2.6 2.6 0 0 1 .413 1.415" clip-rule="evenodd"></path></g><path fill="#fff" d="M50.151 28.543q-1.196 0-1.953-.732-.732-.757-.732-2.002v-6.834H44.44v-2.539h3.027v-3.759h3.076v3.76h3.32v2.538h-3.32v6.297q0 .733.683.733h2.343v2.538zM59.428 28.885q-1.294 0-2.319-.44a4 4 0 0 1-1.635-1.318q-.585-.878-.586-2.123 0-1.245.586-2.075.61-.855 1.66-1.27 1.074-.439 2.44-.439h3.32v-.683q0-.855-.537-1.391-.537-.562-1.709-.562-1.147 0-1.708.537-.562.513-.733 1.343l-2.831-.952q.292-.928.928-1.684.659-.782 1.733-1.245 1.098-.489 2.66-.488 2.392 0 3.784 1.196 1.39 1.195 1.39 3.466v4.515q0 .733.684.733h.977v2.538h-2.05q-.904 0-1.49-.44a1.39 1.39 0 0 1-.585-1.17v-.025h-.464q-.098.293-.44.78-.34.465-1.074.83-.732.367-2.001.367m.537-2.49q1.293 0 2.1-.708.828-.731.829-1.928v-.244h-3.1q-.855 0-1.342.366-.489.366-.489 1.025 0 .66.513 1.074t1.489.415M68.804 28.543V16.436h3.076v12.107zm1.538-13.522a2.02 2.02 0 0 1-1.416-.538q-.561-.537-.561-1.415 0-.879.561-1.416a2.02 2.02 0 0 1 1.416-.537q.854 0 1.416.537t.561 1.416-.561 1.415-1.416.537M74.311 28.543V11.457h3.076v17.086zM85.506 28.885q-1.757 0-3.198-.732a5.53 5.53 0 0 1-2.245-2.124q-.83-1.39-.83-3.369v-.341q0-1.977.83-3.369a5.53 5.53 0 0 1 2.245-2.123q1.44-.733 3.198-.733 1.733 0 2.978.61t2.002 1.685q.78 1.05 1.025 2.392l-2.978.635a3.5 3.5 0 0 0-.44-1.318q-.341-.586-.976-.928-.61-.342-1.538-.342-.927 0-1.684.415-.732.391-1.172 1.196-.415.781-.415 1.929v.244q0 1.148.415 1.953.44.78 1.172 1.195.757.39 1.684.391 1.392 0 2.1-.708.732-.732.927-1.904l2.978.708a6.7 6.7 0 0 1-1.099 2.368q-.756 1.05-2.001 1.66t-2.978.61M96.904 28.885q-1.294 0-2.32-.44a4 4 0 0 1-1.635-1.318q-.585-.878-.585-2.123t.585-2.075q.61-.855 1.66-1.27 1.074-.439 2.441-.439h3.32v-.683q0-.855-.537-1.391-.537-.562-1.709-.562-1.147 0-1.709.537-.561.513-.732 1.343l-2.831-.952a4.9 4.9 0 0 1 .927-1.684q.66-.782 1.733-1.245 1.1-.489 2.66-.488 2.394 0 3.784 1.196 1.392 1.195 1.392 3.466v4.515q0 .733.683.733h.976v2.538h-2.05q-.903 0-1.489-.44a1.4 1.4 0 0 1-.586-1.17v-.025h-.463q-.099.293-.44.78-.342.465-1.074.83-.732.367-2.001.367m.537-2.49q1.293 0 2.099-.708.83-.731.83-1.928v-.244h-3.1q-.854 0-1.343.366-.488.366-.488 1.025 0 .66.513 1.074.512.415 1.489.415M106.28 28.543V11.457h3.075v17.086zM111.787 28.543V11.457h3.076v17.086z"></path><defs><clipPath id="a"><path fill="#fff" d="M0 0h35.838v40H0z"></path></clipPath></defs></svg><div class="text-content-tiny sm:text-title-small space-x-SPACE_06 text-tailCall-light-500 z-10"><a class="text-tailCall-light-500 hover:text-tailCall-light-300 hover:no-underline" href="/docs/">Documentation</a><a href="https://blog.tailcall.run/" target="_blank" rel="noopener noreferrer" class="text-tailCall-light-500 hover:text-tailCall-light-300 hover:no-underline">Blog</a><a class="text-tailCall-light-500 hover:text-tailCall-light-300 hover:no-underline" href="/docs/contribution-guidelines/">Contributors</a><a class="text-tailCall-light-500 hover:text-tailCall-light-300 hover:no-underline" href="/privacy/">Privacy Policy</a></div><div class="flex flex-col sm:flex-row items-center gap-y-SPACE_04 sm:justify-between w-[100%] max-w-7xl sm:mt-SPACE_10 z-10"><p class="text-content-tiny text-tailCall-light-700 font-space-mono font-normal cursor-pointer mb-0 sm:mb-5 order-2 sm:order-1">Cookie Settings</p><p class="text-content-tiny text-tailCall-light-700 font-space-mono font-normal mb-0 sm:mb-5 order-3 sm:order-2">Copyright © <!-- -->2024<!-- --> Tailcall, Inc.</p><div class="space-x-SPACE_04 order-1 sm:order-3"><a href="https://github.com/tailcallhq/tailcall" target="_blank" rel="noopener noreferrer" class="cursor-pointer"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="h-6 w-6"><g clip-path="url(#a)"><path fill="#B6B6B7" fill-rule="evenodd" d="M11.967 1C5.903 1 1 6.042 1 12.279c0 4.986 3.141 9.206 7.5 10.7.544.112.743-.243.743-.542 0-.261-.017-1.157-.017-2.091C6.175 21.018 5.539 19 5.539 19c-.49-1.307-1.216-1.643-1.216-1.643-.999-.69.072-.69.072-.69 1.108.074 1.69 1.157 1.69 1.157.98 1.718 2.56 1.232 3.195.934.09-.729.381-1.233.69-1.513-2.433-.261-4.993-1.232-4.993-5.565 0-1.232.435-2.24 1.125-3.025-.109-.28-.49-1.438.11-2.988 0 0 .925-.298 3.013 1.158a10.3 10.3 0 0 1 2.742-.373c.926 0 1.87.13 2.742.373 2.088-1.456 3.014-1.158 3.014-1.158.6 1.55.218 2.708.109 2.988.708.784 1.126 1.793 1.126 3.025 0 4.333-2.56 5.285-5.012 5.565.4.355.745 1.027.745 2.092 0 1.512-.018 2.726-.018 3.1 0 .298.2.653.744.54 4.358-1.493 7.5-5.713 7.5-10.7C22.933 6.043 18.013 1 11.966 1" clip-rule="evenodd"></path></g><defs><clipPath id="a"><path fill="#fff" d="M1 1h22v22H1z"></path></clipPath></defs></svg></a><a href="https://discord.gg/kRZBPpkgwq" target="_blank" rel="noopener noreferrer" class="cursor-pointer"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="h-6 w-6"><mask id="a" width="20" height="16" x="2" y="4" maskUnits="userSpaceOnUse" style="mask-type:luminance"><path fill="#fff" d="M22 4H2v16h20z"></path></mask><g mask="url(#a)"><path fill="#B6B6B7" d="M18.93 5.425a16.1 16.1 0 0 0-4.07-1.304.06.06 0 0 0-.066.032c-.175.323-.37.744-.506 1.075a14.8 14.8 0 0 0-4.573 0A11 11 0 0 0 9.2 4.153a.06.06 0 0 0-.065-.032 16 16 0 0 0-4.07 1.304.06.06 0 0 0-.028.024c-2.593 4-3.303 7.902-2.954 11.756a.07.07 0 0 0 .026.048 16.4 16.4 0 0 0 4.994 2.608.06.06 0 0 0 .07-.024 12.3 12.3 0 0 0 1.022-1.716.066.066 0 0 0-.035-.091 11 11 0 0 1-1.56-.768.068.068 0 0 1-.007-.11q.159-.122.31-.251a.06.06 0 0 1 .065-.01c3.273 1.544 6.817 1.544 10.051 0a.06.06 0 0 1 .066.01c.1.084.205.17.31.25a.068.068 0 0 1-.005.11q-.747.45-1.561.768a.067.067 0 0 0-.034.091c.3.601.643 1.173 1.02 1.716a.06.06 0 0 0 .07.025 16.3 16.3 0 0 0 5.003-2.608.07.07 0 0 0 .026-.047c.417-4.455-.699-8.325-2.957-11.756a.05.05 0 0 0-.026-.025M8.684 14.86c-.985 0-1.797-.935-1.797-2.082 0-1.148.796-2.082 1.797-2.082 1.01 0 1.814.943 1.798 2.082 0 1.147-.796 2.082-1.798 2.082m6.646 0c-.985 0-1.797-.935-1.797-2.082 0-1.148.796-2.082 1.797-2.082 1.009 0 1.813.943 1.797 2.082 0 1.147-.788 2.082-1.797 2.082"></path></g></svg></a><a href="https://www.linkedin.com/company/tailcall" target="_blank" rel="noopener noreferrer" class="cursor-pointer"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="h-6 w-6"><mask id="a" width="18" height="18" x="3" y="3" maskUnits="userSpaceOnUse" style="mask-type:luminance"><path fill="#fff" d="M21 3H3v18h18z"></path></mask><g mask="url(#a)"><path fill="#B6B6B7" d="M8.178 19V9.554H5.177V19zm-1.5-10.736c1.046 0 1.698-.725 1.698-1.632C8.356 5.705 7.724 5 6.698 5 5.671 5 5 5.705 5 6.632c0 .907.651 1.632 1.658 1.632zM9.84 19h3.001v-5.275c0-.282.02-.564.099-.766.217-.564.71-1.148 1.54-1.148 1.086 0 1.52.866 1.52 2.136V19H19v-5.416c0-2.902-1.48-4.252-3.455-4.252-1.619 0-2.33.947-2.725 1.591h.02v-1.37h-3c.039.887 0 9.447 0 9.447"></path></g></svg></a><a href="https://twitter.com/tailcallhq" target="_blank" rel="noopener noreferrer" class="cursor-pointer"><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none" viewBox="0 0 28 28" class="h-6 w-6"><path fill="#B6B6B7" d="M18.745 6.428h2.53l-5.528 6.318 6.503 8.597h-5.092l-3.988-5.215-4.563 5.215H6.076l5.912-6.758L5.75 6.428h5.22l3.605 4.766zm-.888 13.4h1.402l-9.05-11.965H8.705z"></path></svg></a></div></div></footer></div>
</body>
</html>